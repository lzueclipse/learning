#Ceph Architecture/Ceph Components

##本章会先粗略构建一个big picture，然后后续章节会展开详细介绍

##1. Ceph架构以及主要模块

![图1](https://github.com/lzueclipse/learning/blob/master/ceph/day0002/1.png "图1")

如图1所示，Ceph主要模块图。

##2. RADOS
全称是Reliable Automatic Distributed Object Store，是Ceph的基础。

在底层，Ceph是以object来存储的。

RADOS负责数据的可靠性和一致性(错误发现，错误恢复，data replication)。
当Ceph cluster收到一个write request，CRUSH（Controlled Replication Under Scalable Hash）算法计算出
将要写入的OSD位置，RADOS会收到这个位置信息，并根据系统配置的CRUSH rulset进行replication。


相关命令：

```
[root@node1 ~]# rados lspools
rbd
```

```
[root@node1 ~]# rados -p rbd ls
```

```
[root@node1 ~]# rados df
pool name                 KB      objects       clones     degraded      unfound           rd        rd KB           wr        wr KB
rbd                        0            0            0            0           0            0            0            0            0
  total used          324084            0
  total avail      141132120
  total space      141456204
```

###2.1. OSD

![图2](https://github.com/lzueclipse/learning/blob/master/ceph/day0002/2.png "图2")

全称是Object Storage Device，是真正存放数据的。

一般一个物理硬盘，会绑定一个OSD daemon。

对于每一个object，有一个primary copy，和几个secondary copy。
每一个OSD是某些object的primary OSD，同时又是其他某些object的secondary OSD；
对于某一个object，当它的primary OSD挂掉后，其secondary OSD是需要提升为primary OSD的。

从Ceph Firefly release(0.80)，除了replication，还支持Erasure coding（纠删码）。

#####2.1.1. OSD选用的文件系统

OSD daemon要求文件系统支持扩展属性(XATTRS)，这些扩展属性被用来存储object state, snapshot, metadata, ACL等内部信息。

目前官方推荐使用XFS。
Ext4的XATTRS过小，Btrfs不建议用在生产环境。

#####2.1.2. OSD journal

![图3](https://github.com/lzueclipse/learning/blob/master/ceph/day0002/3.png "图3")


Ceph先写Journal，后写数据。

建议Jouranl用SSD，以提高效率。

#####2.1.3 OSD commands

```
[root@node1 ~]# service ceph status osd
=== osd.0 ===
osd.0: running {"version":"0.94.2"}
=== osd.1 ===
osd.1: running {"version":"0.94.2"}
=== osd.2 ===
osd.2: running {"version":"0.94.2"}
```
```
[root@node1 ~]# ceph osd ls
0
1
2
3
4
5
6
7
8
```
```
[root@node1 ~]# ceph osd stat
     osdmap e68: 9 osds: 9 up, 9 in
```
```
[root@node1 ~]# ceph osd  tree
ID WEIGHT  TYPE NAME      UP/DOWN REWEIGHT PRIMARY-AFFINITY
-1 0.08995 root default
-2 0.02998     host node1
 0 0.00999         osd.0       up  1.00000          1.00000
 1 0.00999         osd.1       up  1.00000          1.00000
 2 0.00999         osd.2       up  1.00000          1.00000
-3 0.02998     host node2
 3 0.00999         osd.3       up  1.00000          1.00000
 4 0.00999         osd.4       up  1.00000          1.00000
 5 0.00999         osd.5       up  1.00000          1.00000
-4 0.02998     host node3
 6 0.00999         osd.6       up  1.00000          1.00000
 7 0.00999         osd.7       up  1.00000          1.00000
 8 0.00999         osd.8       up  1.00000          1.00000
```

###2.2. MON

Monitor，可以有多个（奇数个），采用Paxos算法作为选举算法，主要维护系统运行所需的一些状态信息。

#####2.2.1 MON map
维护了所有monitor node的信息。
```
[root@node1 ~]# ceph mon dump
dumped monmap epoch 3
epoch 3
fsid 8c3fb7e2-6750-4e8e-b3f0-ad6afe25bb1a
last_changed 2015-07-05 15:40:05.539170
created 0.000000
0: 10.200.29.191:6789/0 mon.node1
1: 10.200.29.192:6789/0 mon.node2
2: 10.200.29.193:6789/0 mon.node3
```
 
#####2.2.2. OSD map
维护了所有OSD 的信息。
```
[root@node1 ~]# ceph osd dump
epoch 68
fsid 8c3fb7e2-6750-4e8e-b3f0-ad6afe25bb1a
created 2015-07-03 11:41:21.879644
modified 2015-07-16 15:28:33.591573
flags
pool 0 'rbd' replicated size 3 min_size 2 crush_ruleset 0 object_hash rjenkins pg_num 64 pgp_num 64 last_change 1 flags hashpspool stripe_width 0
max_osd 9
osd.0 up   in  weight 1 up_from 67 up_thru 67 down_at 65 last_clean_interval [4,66) 10.200.29.191:6800/24478 10.200.29.191:6811/3024478 10.200.29.191:6813/3024478 10.200.29.191:6814/3024478 exists,up 9f8bc2ee-9d7a-4e9c-8238-690578d8629b
osd.1 up   in  weight 1 up_from 67 up_thru 67 down_at 65 last_clean_interval [8,66) 10.200.29.191:6804/25361 10.200.29.191:6802/3025361 10.200.29.191:6805/3025361 10.200.29.191:6815/3025361 exists,up 10faed08-db17-4fc0-97e6-d49685d472df
osd.2 up   in  weight 1 up_from 67 up_thru 67 down_at 65 last_clean_interval [12,66) 10.200.29.191:6808/26574 10.200.29.191:6801/3026574 10.200.29.191:6809/3026574 10.200.29.191:6812/3026574 exists,up 43e671a0-fe74-4a31-8bac-acc09ce4fec5
osd.3 up   in  weight 1 up_from 16 up_thru 67 down_at 0 last_clean_interval [0,0) 10.200.29.192:6800/2479 10.200.29.192:6801/2479 10.200.29.192:6802/2479 10.200.29.192:6803/2479 exists,up 5fe8f917-f082-4d08-8dc6-519d30b59f03
osd.4 up   in  weight 1 up_from 21 up_thru 67 down_at 0 last_clean_interval [0,0) 10.200.29.192:6804/3457 10.200.29.192:6805/3457 10.200.29.192:6806/3457 10.200.29.192:6807/3457 exists,up a21c86c1-2a32-4cc8-9d63-df7f56824a2f
osd.5 up   in  weight 1 up_from 26 up_thru 67 down_at 0 last_clean_interval [0,0) 10.200.29.192:6808/4586 10.200.29.192:6809/4586 10.200.29.192:6810/4586 10.200.29.192:6811/4586 exists,up d5f0f83b-4a64-49ad-91be-2c7e9bea1b33
osd.6 up   in  weight 1 up_from 47 up_thru 67 down_at 44 last_clean_interval [31,45) 10.200.29.193:6800/29733 10.200.29.193:6805/1029733 10.200.29.193:6816/1029733 10.200.29.193:6817/1029733 exists,up 745644bd-6cbf-404e-ab24-468625ecda64
osd.7 up   in  weight 1 up_from 46 up_thru 67 down_at 44 last_clean_interval [36,45) 10.200.29.193:6804/30754 10.200.29.193:6809/1030754 10.200.29.193:6811/1030754 10.200.29.193:6815/1030754 exists,up d035a268-0913-4b61-bc8d-33157664a5cc
osd.8 up   in  weight 1 up_from 46 up_thru 67 down_at 44 last_clean_interval [41,45) 10.200.29.193:6808/31947 10.200.29.193:6812/1031947 10.200.29.193:6813/1031947 10.200.29.193:6814/1031947 exists,up 281879eb-c283-4f26-91e3-2d5b02a80f86
```

#####2.2.3. PG map
保存了Placement Group 的信息。
```
[root@node1 ~]# ceph pg dump
dumped all in format plain
version 955
stamp 2015-07-23 19:11:12.054630
last_osdmap_epoch 68
last_pg_scan 1
full_ratio 0.95
nearfull_ratio 0.85
pg_stat objects mip     degr    misp    unf     bytes   log     disklog state   state_stamp     v       reported        up      up_primary      acting  acting_primary  last_scrub  scrub_stamp     last_deep_scrub deep_scrub_stamp
0.22    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:17.151816      0'0     68:88   [8,5,0] 8       [8,5,0] 8       0'02015-07-23 19:08:17.151741       0'0     2015-07-17 19:08:02.996970
0.21    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:39.746934      0'0     68:131  [3,7,1] 3       [3,7,1] 3       0'02015-07-23 19:08:39.746843       0'0     2015-07-17 19:08:20.078640
0.20    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:31.745368      0'0     68:116  [3,2,7] 3       [3,2,7] 3       0'02015-07-23 19:08:31.745275       0'0     2015-07-17 19:08:15.078316
0.1f    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:54.153648      0'0     68:89   [6,2,4] 6       [6,2,4] 6       0'02015-07-23 19:08:54.153577       0'0     2015-07-17 19:08:47.047827
0.1e    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:15.741150      0'0     68:126  [5,1,8] 5       [5,1,8] 5       0'02015-07-23 19:08:15.741095       0'0     2015-07-17 19:07:51.072564
0.1d    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:57.737914      0'0     68:101  [5,0,6] 5       [5,0,6] 5       0'02015-07-23 19:07:57.737867       0'0     2015-07-17 19:07:41.069868
0.1c    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:18.744487      0'0     68:103  [3,6,0] 3       [3,6,0] 3       0'02015-07-23 19:08:18.744397       0'0     2015-07-17 19:08:03.077189
0.1b    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:17.742916      0'0     68:110  [4,6,0] 4       [4,6,0] 4       0'02015-07-23 19:08:17.742834       0'0     2015-07-17 19:07:57.074977
0.1a    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:53.738363      0'0     68:102  [5,1,6] 5       [5,1,6] 5       0'02015-07-23 19:07:53.738302       0'0     2015-07-17 19:07:28.027641
0.19    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:23.288115      0'0     68:121  [0,6,5] 0       [0,6,5] 0       0'02015-07-23 19:08:23.288042       0'0     2015-07-17 19:08:00.865340
0.18    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:14.151338      0'0     68:88   [7,2,4] 7       [7,2,4] 7       0'02015-07-23 19:08:14.151190       0'0     2015-07-17 19:08:05.038864
0.17    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:14.288440      0'0     68:115  [0,5,6] 0       [0,5,6] 0       0'02015-07-23 19:08:14.288373       0'0     2015-07-17 19:07:56.864630
0.16    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:28.138644      0'0     68:86   [8,3,1] 8       [8,3,1] 8       0'02015-07-23 19:07:28.138352       0'0     2015-07-17 19:07:13.991604
0.15    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:01.282703      0'0     68:103  [2,6,5] 2       [2,6,5] 2       0'02015-07-23 19:08:01.282638       0'0     2015-07-17 19:07:46.457525
0.14    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:15.287328      0'0     68:103  [1,6,3] 1       [1,6,3] 1       0'02015-07-23 19:08:15.287279       0'0     2015-07-17 19:07:46.862136
0.13    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:16.741721      0'0     68:116  [3,7,1] 3       [3,7,1] 3       0'02015-07-23 19:08:16.741630       0'0     2015-07-17 19:08:01.074509
0.12    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:56.738990      0'0     68:107  [4,7,0] 4       [4,7,0] 4       0'02015-07-23 19:07:56.738925       0'0     2015-07-17 19:07:43.072247
0.11    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:54.740998      0'0     68:126  [4,8,2] 4       [4,8,2] 4       0'02015-07-23 19:07:54.740931       0'0     2015-07-17 19:07:35.276951
0.10    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:09.286619      0'0     68:94   [0,7,4] 0       [0,7,4] 0       0'02015-07-23 19:08:09.286561       0'0     2015-07-17 19:07:38.861358
0.f     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:50.280769      0'0     68:111  [2,7,3] 2       [2,7,3] 2       0'02015-07-23 19:07:50.280712       0'0     2015-07-17 19:07:37.455621
0.e     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:46.279673      0'0     68:102  [2,3,7] 2       [2,3,7] 2       0'02015-07-23 19:07:46.279593       0'0     2015-07-17 19:07:30.416309
0.d     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:40.151739      0'0     68:88   [6,3,2] 6       [6,3,2] 6       0'02015-07-23 19:08:40.151673       0'0     2015-07-17 19:08:31.044006
0.c     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:52.738110      0'0     68:101  [5,6,0] 5       [5,6,0] 5       0'02015-07-23 19:07:52.738056       0'0     2015-07-17 19:07:21.026093
0.b     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:41.281893      0'0     68:102  [2,3,7] 2       [2,3,7] 2       0'02015-07-23 19:07:41.281800       0'0     2015-07-17 19:07:25.417622
0.a     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:33.149742      0'0     68:128  [6,5,0] 6       [6,5,0] 6       0'02015-07-23 19:08:33.149674       0'0     2015-07-17 19:08:21.042008
0.9     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:11.284735      0'0     68:116  [1,4,7] 1       [1,4,7] 1       0'02015-07-23 19:08:11.284667       0'0     2015-07-17 19:07:44.860379
0.8     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:01.741004      0'0     68:110  [3,6,1] 3       [3,6,1] 3       0'02015-07-23 19:08:01.740835       0'0     2015-07-17 19:07:48.071703
0.7     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:59.284454      0'0     68:128  [1,7,4] 1       [1,7,4] 1       0'02015-07-23 19:07:59.284393       0'0     2015-07-17 19:07:37.858840
0.6     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:13.290627      0'0     68:124  [0,8,4] 0       [0,8,4] 0       0'02015-07-23 19:08:13.290534       0'0     2015-07-17 19:07:51.863503
0.5     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:49.140595      0'0     68:88   [6,2,3] 6       [6,2,3] 6       0'02015-07-23 19:07:49.140488       0'0     2015-07-17 19:07:36.036157
0.4     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:09.740582      0'0     68:124  [3,8,2] 3       [3,8,2] 3       0'02015-07-23 19:08:09.740458       0'0     2015-07-17 19:07:49.071846
0.3     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:28.731596      0'0     68:116  [5,0,8] 5       [5,0,8] 5       0'02015-07-23 19:07:28.731440       0'0     2015-07-17 19:07:18.026910
0.2     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:59.742361      0'0     68:116  [3,1,7] 3       [3,1,7] 3       0'02015-07-23 19:07:59.742247       0'0     2015-07-17 19:07:39.071325
0.1     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:35.741004      0'0     68:113  [3,6,1] 3       [3,6,1] 3       0'02015-07-23 19:07:35.740814       0'0     2015-07-17 19:07:29.027853
0.0     0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:12.285214      0'0     68:115  [0,4,7] 0       [0,4,7] 0       0'02015-07-23 19:08:12.285139       0'0     2015-07-17 19:07:50.861705
0.3f    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:53.294751      0'0     68:106  [2,8,3] 2       [2,8,3] 2       0'02015-07-23 19:08:53.294650       0'0     2015-07-17 19:08:20.466152
0.3e    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:27.153978      0'0     68:88   [7,0,4] 7       [7,0,4] 7       0'02015-07-23 19:08:27.153890       0'0     2015-07-17 19:08:09.039787
0.3d    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:33.290270      0'0     68:117  [1,7,5] 1       [1,7,5] 1       0'02015-07-23 19:08:33.290199       0'0     2015-07-17 19:08:15.868813
0.3c    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:09:00.752024      0'0     68:114  [4,1,8] 4       [4,1,8] 4       0'02015-07-23 19:09:00.751956       0'0     2015-07-17 19:08:32.081201
0.3b    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:52.294257      0'0     68:113  [2,8,4] 2       [2,8,4] 2       0'02015-07-23 19:08:52.294172       0'0     2015-07-17 19:08:16.465529
0.3a    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:44.292311      0'0     68:103  [2,6,3] 2       [2,6,3] 2       0'02015-07-23 19:08:44.292230       0'0     2015-07-17 19:08:14.464666
0.39    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:57.750355      0'0     68:114  [4,2,8] 4       [4,2,8] 4       0'02015-07-23 19:08:57.750299       0'0     2015-07-17 19:08:31.080598
0.38    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:48.748688      0'0     68:126  [4,2,8] 4       [4,2,8] 4       0'02015-07-23 19:08:48.748492       0'0     2015-07-17 19:08:29.079695
0.37    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:34.745701      0'0     68:114  [4,2,7] 4       [4,2,7] 4       0'02015-07-23 19:08:34.745647       0'0     2015-07-17 19:08:08.075616
0.36    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:32.745261      0'0     68:108  [4,8,2] 4       [4,8,2] 4       0'02015-07-23 19:08:32.745210       0'0     2015-07-17 19:08:07.075939
0.35    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:00.740926      0'0     68:108  [5,7,2] 5       [5,7,2] 5       0'02015-07-23 19:08:00.740865       0'0     2015-07-17 19:07:45.071061
0.34    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:09:02.808687      0'0     68:103  [3,7,0] 3       [3,7,0] 3       0'02015-07-23 19:09:02.808604       0'0     2015-07-17 19:08:37.082454
0.33    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:49.806804      0'0     68:121  [3,8,2] 3       [3,8,2] 3       0'02015-07-23 19:08:49.806714       0'0     2015-07-17 19:08:34.081594
0.32    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:28.289112      0'0     68:103  [2,6,3] 2       [2,6,3] 2       0'02015-07-23 19:08:28.289025       0'0     2015-07-17 19:08:09.463481
0.31    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:31.289675      0'0     68:125  [1,7,4] 1       [1,7,4] 1       0'02015-07-23 19:08:31.289613       0'0     2015-07-17 19:08:10.866575
0.30    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:40.144397      0'0     68:87   [8,1,3] 8       [8,1,3] 8       0'02015-07-23 19:07:40.144323       0'0     2015-07-17 19:07:25.989180
0.2f    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:09:09.162004      0'0     68:88   [8,5,0] 8       [8,5,0] 8       0'02015-07-23 19:09:09.161930       0'0     2015-07-17 19:08:48.007943
0.2e    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:27.289217      0'0     68:88   [2,3,6] 2       [2,3,6] 2       0'02015-07-23 19:08:27.289135       0'0     2015-07-17 19:08:05.462092
0.2d    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:44.747756      0'0     68:112  [3,7,0] 3       [3,7,0] 3       0'02015-07-23 19:08:44.747678       0'0     2015-07-17 19:08:32.081360
0.2c    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:44.157625      0'0     68:88   [8,0,4] 8       [8,0,4] 8       0'02015-07-23 19:08:44.157543       0'0     2015-07-17 19:08:34.005028
0.2b    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:26.743874      0'0     68:117  [4,7,1] 4       [4,7,1] 4       0'02015-07-23 19:08:26.743822       0'0     2015-07-17 19:08:06.074708
0.2a    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:32.155317      0'0     68:89   [8,3,2] 8       [8,3,2] 8       0'02015-07-23 19:08:32.155227       0'0     2015-07-17 19:08:18.000989
0.29    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:31.154962      0'0     68:89   [8,1,3] 8       [8,1,3] 8       0'02015-07-23 19:08:31.154879       0'0     2015-07-17 19:08:15.000588
0.28    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:15.288437      0'0     68:139  [2,5,8] 2       [2,5,8] 2       0'02015-07-23 19:08:15.288276       0'0     2015-07-17 19:08:03.462244
0.27    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:07:18.126642      0'0     68:101  [1,3,7] 1       [1,3,7] 1       0'02015-07-23 19:07:18.126569       0'0     2015-07-17 19:07:10.716839
0.26    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:24.287803      0'0     68:104  [1,4,6] 1       [1,4,6] 1       0'02015-07-23 19:08:24.287728       0'0     2015-07-17 19:08:07.865804
0.25    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:43.747990      0'0     68:115  [3,0,7] 3       [3,0,7] 3       0'02015-07-23 19:08:43.747881       0'0     2015-07-17 19:08:31.081518
0.24    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:18.151983      0'0     68:88   [8,0,3] 8       [8,0,3] 8       0'02015-07-23 19:08:18.151904       0'0     2015-07-17 19:08:04.997947
0.23    0       0       0       0       0       0       0       0       active+clean    2015-07-23 19:08:42.747430      0'0     68:110  [3,7,1] 3       [3,7,1] 3       0'02015-07-23 19:08:42.747324       0'0     2015-07-17 19:08:21.079298
pool 0  0       0       0       0       0       0       0       0
 sum    0       0       0       0       0       0       0       0
osdstat kbused  kbavail kb      hb in   hb out
0       36348   15681008        15717356        [1,2,3,4,5,6,7,8]       []
1       36008   15681348        15717356        [0,2,3,4,5,6,7,8]       []
2       36176   15681180        15717356        [0,1,3,4,5,6,7,8]       []
3       36788   15680568        15717356        [0,1,2,4,5,6,7,8]       []
4       36012   15681344        15717356        [0,1,2,3,5,6,7,8]       []
5       35428   15681928        15717356        [0,1,2,3,4,6,7,8]       []
6       35904   15681452        15717356        [0,1,2,3,4,5,7,8]       []
7       35868   15681488        15717356        [0,1,2,3,4,5,6,8]       []
8       35552   15681804        15717356        [0,1,2,3,4,5,6,7]       []
 sum    324084  141132120       141456204
```

#####2.2.4. CRUSH Map 
维护了CRUSH ruleset的信息。
```
[root@node1 ~]# ceph osd crush dump
{
    "devices": [
        {
            "id": 0,
            "name": "osd.0"
        },
        {
            "id": 1,
            "name": "osd.1"
        },
        {
            "id": 2,
            "name": "osd.2"
        },
        {
            "id": 3,
            "name": "osd.3"
        },
        {
            "id": 4,
            "name": "osd.4"
        },
        {
            "id": 5,
            "name": "osd.5"
        },
        {
            "id": 6,
            "name": "osd.6"
        },
        {
            "id": 7,
            "name": "osd.7"
        },
        {
            "id": 8,
            "name": "osd.8"
        }
    ],
    "types": [
        {
            "type_id": 0,
            "name": "osd"
        },
        {
            "type_id": 1,
            "name": "host"
        },
        {
            "type_id": 2,
            "name": "chassis"
        },
        {
            "type_id": 3,
            "name": "rack"
        },
        {
            "type_id": 4,
            "name": "row"
        },
        {
            "type_id": 5,
            "name": "pdu"
        },
        {
            "type_id": 6,
            "name": "pod"
        },
        {
            "type_id": 7,
            "name": "room"
        },
        {
            "type_id": 8,
            "name": "datacenter"
        },
        {
            "type_id": 9,
            "name": "region"
        },
        {
            "type_id": 10,
            "name": "root"
        }
    ],
    "buckets": [
        {
            "id": -1,
            "name": "default",
            "type_id": 10,
            "type_name": "root",
            "weight": 5895,
            "alg": "straw",
            "hash": "rjenkins1",
            "items": [
                {
                    "id": -2,
                    "weight": 1965,
                    "pos": 0
                },
                {
                    "id": -3,
                    "weight": 1965,
                    "pos": 1
                },
                {
                    "id": -4,
                    "weight": 1965,
                    "pos": 2
                }
            ]
        },
        {
            "id": -2,
            "name": "node1",
            "type_id": 1,
            "type_name": "host",
            "weight": 1965,
            "alg": "straw",
            "hash": "rjenkins1",
            "items": [
                {
                    "id": 0,
                    "weight": 655,
                    "pos": 0
                },
                {
                    "id": 1,
                    "weight": 655,
                    "pos": 1
                },
                {
                    "id": 2,
                    "weight": 655,
                    "pos": 2
                }
            ]
        },
        {
            "id": -3,
            "name": "node2",
            "type_id": 1,
            "type_name": "host",
            "weight": 1965,
            "alg": "straw",
            "hash": "rjenkins1",
            "items": [
                {
                    "id": 3,
                    "weight": 655,
                    "pos": 0
                },
                {
                    "id": 4,
                    "weight": 655,
                    "pos": 1
                },
                {
                    "id": 5,
                    "weight": 655,
                    "pos": 2
                }
            ]
        },
        {
            "id": -4,
            "name": "node3",
            "type_id": 1,
            "type_name": "host",
            "weight": 1965,
            "alg": "straw",
            "hash": "rjenkins1",
            "items": [
                {
                    "id": 6,
                    "weight": 655,
                    "pos": 0
                },
                {
                    "id": 7,
                    "weight": 655,
                    "pos": 1
                },
                {
                    "id": 8,
                    "weight": 655,
                    "pos": 2
                }
            ]
        }
    ],
    "rules": [
        {
            "rule_id": 0,
            "rule_name": "replicated_ruleset",
            "ruleset": 0,
            "type": 1,
            "min_size": 1,
            "max_size": 10,
            "steps": [
                {
                    "op": "take",
                    "item": -1,
                    "item_name": "default"
                },
                {
                    "op": "chooseleaf_firstn",
                    "num": 0,
                    "type": "host"
                },
                {
                    "op": "emit"
                }
            ]
        }
    ],
    "tunables": {
        "choose_local_tries": 0,
        "choose_local_fallback_tries": 0,
        "choose_total_tries": 50,
        "chooseleaf_descend_once": 1,
        "chooseleaf_vary_r": 0,
        "straw_calc_version": 1,
        "allowed_bucket_algs": 22,
        "profile": "unknown",
        "optimal_tunables": 0,
        "legacy_tunables": 0,
        "require_feature_tunables": 1,
        "require_feature_tunables2": 1,
        "require_feature_tunables3": 0,
        "has_v2_rules": 0,
        "has_v3_rules": 0,
        "has_v4_buckets": 0
    }
}
```

#####2.2.5. MDS map
维护了MDS信息。
```
[root@node1 ~]# ceph mds dump
dumped mdsmap epoch 1
epoch   1
flags   0
created 0.000000
modified        2015-07-03 11:41:21.879452
tableserver     0
root    0
session_timeout 0
session_autoclose       0
max_file_size   0
last_failure    0
last_failure_osd_epoch  0
compat  compat={},rocompat={},incompat={}
max_mds 0
in
up      {}
failed
stopped
data_pools
metadata_pool   0
inline_data     disabled
```

#####2.2.6. MON commands
```
[root@node1 ~]# ceph daemon mon.node1 mon_status
{
    "name": "node1",
    "rank": 0,
    "state": "leader",
    "election_epoch": 28,
    "quorum": [
        0,
        1,
        2
    ],
    "outside_quorum": [],
    "extra_probe_peers": [
        "10.200.29.192:6789\/0"
    ],
    "sync_provider": [],
    "monmap": {
        "epoch": 3,
        "fsid": "8c3fb7e2-6750-4e8e-b3f0-ad6afe25bb1a",
        "modified": "2015-07-05 15:40:05.539170",
        "created": "0.000000",
        "mons": [
            {
                "rank": 0,
                "name": "node1",
                "addr": "10.200.29.191:6789\/0"
            },
            {
                "rank": 1,
                "name": "node2",
                "addr": "10.200.29.192:6789\/0"
            },
            {
                "rank": 2,
                "name": "node3",
                "addr": "10.200.29.193:6789\/0"
            }
        ]
    }
}
```
```
[root@node1 ~]# service ceph status mon
=== mon.node1 ===
mon.node1: running {"version":"0.94.2"}
```
```
[root@node1 ~]# ceph mon stat
e3: 3 mons at {node1=10.200.29.191:6789/0,node2=10.200.29.192:6789/0,node3=10.200.29.193:6789/0}, election epoch 28, quorum 0,1,2 node1,node2,node3
```
```
[root@node1 ~]# ceph mon_status
{"name":"node1","rank":0,"state":"leader","election_epoch":28,"quorum":[0,1,2],"outside_quorum":[],"extra_probe_peers":["10.200.29.192:6789\/0"],"sync_provider":[],"monmap":{"epoch":3,"fsid":"8c3fb7e2-6750-4e8e-b3f0-ad6afe25bb1a","modified":"2015-07-05 15:40:05.539170","created":"0.000000","mons":[{"rank":0,"name":"node1","addr":"10.200.29.191:6789\/0"},{"rank":1,"name":"node2","addr":"10.200.29.192:6789\/0"},{"rank":2,"name":"node3","addr":"10.200.29.193:6789\/0"}]}}
```
```
[root@node1 ~]# ceph mon dump
dumped monmap epoch 3
epoch 3
fsid 8c3fb7e2-6750-4e8e-b3f0-ad6afe25bb1a
last_changed 2015-07-05 15:40:05.539170
created 0.000000
0: 10.200.29.191:6789/0 mon.node1
1: 10.200.29.192:6789/0 mon.node2
2: 10.200.29.193:6789/0 mon.node3
```

###2.3. LIBRADOS
LIBRADOS对外提供了访问RADOS的接口。

###2.4. RBD

![图4](https://github.com/lzueclipse/learning/blob/master/ceph/day0002/4.png "图4")

全称是RADOS block device。

提供块存储，支持thin provisioning和snapshots。

如图4所示，支持KRBD和Librbd（python)的形式访问RBD。

###2.5. RGW

![图5](https://github.com/lzueclipse/learning/blob/master/ceph/day0002/5.png "图5")

全称是RADOS Gateway，提供对象存储。

其RESTFUL API接口，兼容Amazon S3和OpenStack Swift，


##3. Ceph FS

Ceph File System。

提供兼容POSIX的分布式文件系统

不成熟，不要用于生产环境，我暂时不去涉及这块。

##4. MDS

全称Metadata Server。

用于存储Ceph FS中的元数据。

不成熟，不要用于生产环境，我暂时不去涉及这块。

